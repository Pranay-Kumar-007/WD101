from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.common.exceptions import StaleElementReferenceException, TimeoutException
import time

def safe_click(driver, wait, by, selector, max_attempts=3):
    """
    Safely click an element, retrying if stale element reference occurs
    """
    for attempt in range(max_attempts):
        try:
            element = wait.until(EC.element_to_be_clickable((by, selector)))
            element.click()
            return True
        except StaleElementReferenceException:
            if attempt < max_attempts - 1:
                print(f"Stale element, retrying... (attempt {attempt + 1}/{max_attempts})")
                time.sleep(0.5)
            else:
                print(f"Failed to click after {max_attempts} attempts")
                raise
    return False

def safe_find_element(driver, by, selector, max_attempts=3):
    """
    Safely find an element, retrying if stale element reference occurs
    """
    for attempt in range(max_attempts):
        try:
            element = driver.find_element(by, selector)
            # Test if element is stale by accessing a property
            _ = element.tag_name
            return element
        except StaleElementReferenceException:
            if attempt < max_attempts - 1:
                print(f"Stale element, retrying... (attempt {attempt + 1}/{max_attempts})")
                time.sleep(0.5)
            else:
                raise
    return None

def main():
    # Set up Chrome options
    chrome_options = Options()
    chrome_options.add_argument('--no-sandbox')
    chrome_options.add_argument('--disable-dev-shm-usage')
    chrome_options.add_argument('--start-maximized')
    
    # Initialize the Chrome driver
    driver = webdriver.Chrome(options=chrome_options)
    wait = WebDriverWait(driver, 10)
    
    try:
        # Step 1: Open the Cisco Meraki API documentation page
        print("Opening Cisco Meraki API documentation page...")
        driver.get("https://developer.cisco.com/meraki/api-v1/")
        time.sleep(2)
        
        # Step 2: Click on the search breadcrumb element
        print("Clicking on the search breadcrumb...")
        search_breadcrumb = wait.until(
            EC.element_to_be_clickable((By.CSS_SELECTOR, "div.doc-breadcrumb__search.gradual-border"))
        )
        search_breadcrumb.click()
        time.sleep(1)
        
        # Step 3: Click on the search input field and enter text
        print("Clicking on the search input field...")
        search_input = wait.until(
            EC.element_to_be_clickable((By.CSS_SELECTOR, "input.search__bar__input"))
        )
        search_input.click()
        time.sleep(0.5)
        
        # Optional: Enter search text if needed (you can modify this)
        # For now, just pressing Enter to show results
        print("Pressing Enter to show results...")
        search_input.send_keys(Keys.RETURN)
        time.sleep(2)
        
        # Step 4: Click on the first result
        print("Clicking on the first search result...")
        first_result = wait.until(
            EC.element_to_be_clickable((By.CSS_SELECTOR, "a.search-name-container"))
        )
        
        # Store the URL or get the href before clicking to handle navigation
        result_url = first_result.get_attribute('href')
        print(f"Navigating to: {result_url}")
        
        first_result.click()
        
        # Wait for the new page to load completely
        # Wait for the URL to change or for a specific element on the new page
        print("Waiting for page to load after navigation...")
        time.sleep(3)  # Give time for page transition
        
        # Wait for document ready state
        wait.until(lambda d: d.execute_script('return document.readyState') == 'complete')
        print(f"Current URL: {driver.current_url}")
        
        # Step 5: Scroll down to find schema definition
        # Re-create WebDriverWait for the new page context
        wait = WebDriverWait(driver, 15)
        
        print("Scrolling down to find schema definition...")
        
        # Function to safely find element with retry logic
        def find_schema_element():
            schema_selectors = [
                "div.schema-definition",
                "button[aria-label*='Schema']",
                "div[id*='schema']",
                "section[id*='schema']",
                ".schema-container",
                "[class*='schema']",
                "a[href*='#schema']",
                "button[class*='schema']"
            ]
            
            for selector in schema_selectors:
                try:
                    # Scroll down to make sure element is in view
                    driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
                    time.sleep(1)
                    
                    # Try to find the element
                    elements = driver.find_elements(By.CSS_SELECTOR, selector)
                    if elements:
                        print(f"Found {len(elements)} element(s) with selector: {selector}")
                        return elements[0], selector
                except Exception as e:
                    continue
            
            return None, None
        
        schema_element, found_selector = find_schema_element()
        
        # If still not found, try scrolling and searching by text
        if not schema_element:
            print("Trying to find schema definition by scrolling and searching by text...")
            last_height = driver.execute_script("return document.body.scrollHeight")
            scroll_attempts = 0
            max_scrolls = 10
            
            while scroll_attempts < max_scrolls:
                driver.execute_script("window.scrollBy(0, 500);")
                time.sleep(0.5)
                scroll_attempts += 1
                
                try:
                    # Try multiple XPath strategies
                    xpath_selectors = [
                        "//*[contains(translate(., 'SCHEMA', 'schema'), 'schema definition')]",
                        "//*[contains(translate(., 'SCHEMA', 'schema'), 'schema')]",
                        "//button[contains(translate(., 'SCHEMA', 'schema'), 'schema')]",
                        "//a[contains(translate(., 'SCHEMA', 'schema'), 'schema')]",
                        "//h2[contains(translate(., 'SCHEMA', 'schema'), 'schema')]",
                        "//h3[contains(translate(., 'SCHEMA', 'schema'), 'schema')]"
                    ]
                    
                    for xpath in xpath_selectors:
                        try:
                            elements = driver.find_elements(By.XPATH, xpath)
                            if elements:
                                schema_element = elements[0]
                                found_selector = xpath
                                print(f"Found schema element by XPath: {xpath}")
                                break
                        except:
                            continue
                    
                    if schema_element:
                        break
                        
                except Exception as e:
                    pass
                
                new_height = driver.execute_script("return document.body.scrollHeight")
                if new_height == last_height:
                    print("Reached bottom of page")
                    break
                last_height = new_height
        
        # Step 6: Click on the schema definition and take screenshot
        if schema_element:
            try:
                print(f"Found schema element with selector: {found_selector}")
                
                # Scroll element into view using JavaScript
                driver.execute_script("arguments[0].scrollIntoView({behavior: 'smooth', block: 'center'});", schema_element)
                time.sleep(1)
                
                # Re-locate the element to avoid stale reference
                if found_selector.startswith("//"):
                    schema_element = wait.until(
                        EC.element_to_be_clickable((By.XPATH, found_selector))
                    )
                else:
                    schema_element = wait.until(
                        EC.element_to_be_clickable((By.CSS_SELECTOR, found_selector))
                    )
                
                print("Clicking on schema definition...")
                # Use JavaScript click to avoid interception issues
                driver.execute_script("arguments[0].click();", schema_element)
                
                # Wait for any expansion/animation to complete
                time.sleep(2)
                
                # Wait for the schema section to be visible
                wait.until(lambda d: d.execute_script('return document.readyState') == 'complete')
                
                # Step 7: Take screenshot of the schema definition
                print("Taking screenshot of schema definition...")
                
                # Try to find the expanded schema content
                time.sleep(1)
                
                # Option 1: Screenshot of the specific element
                try:
                    # Re-locate schema element or find expanded content
                    schema_content_selectors = [
                        "[class*='schema-content']",
                        "[class*='schema-definition']",
                        "[id*='schema']",
                        ".expanded-content"
                    ]
                    
                    schema_content = None
                    for sel in schema_content_selectors:
                        try:
                            schema_content = driver.find_element(By.CSS_SELECTOR, sel)
                            if schema_content and schema_content.is_displayed():
                                break
                        except:
                            continue
                    
                    if schema_content:
                        # Scroll to make sure it's visible
                        driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", schema_content)
                        time.sleep(0.5)
                        
                        # Take screenshot of the element
                        screenshot_path = "/mnt/user-data/outputs/schema_definition_screenshot.png"
                        schema_content.screenshot(screenshot_path)
                        print(f"Element screenshot saved to: {screenshot_path}")
                    else:
                        # Fall back to full page screenshot
                        screenshot_path = "/mnt/user-data/outputs/schema_definition_screenshot.png"
                        driver.save_screenshot(screenshot_path)
                        print(f"Full page screenshot saved to: {screenshot_path}")
                        
                except Exception as e:
                    print(f"Could not take element screenshot: {e}")
                    # Take full page screenshot as fallback
                    screenshot_path = "/mnt/user-data/outputs/schema_definition_screenshot.png"
                    driver.save_screenshot(screenshot_path)
                    print(f"Full page screenshot saved to: {screenshot_path}")
                    
            except Exception as e:
                print(f"Error while clicking or taking screenshot: {str(e)}")
                screenshot_path = "/mnt/user-data/outputs/error_after_click_screenshot.png"
                driver.save_screenshot(screenshot_path)
                print(f"Error screenshot saved to: {screenshot_path}")
                
        else:
            print("Could not find schema definition element. Taking full page screenshot...")
            screenshot_path = "/mnt/user-data/outputs/full_page_screenshot.png"
            driver.save_screenshot(screenshot_path)
            print(f"Screenshot saved to: {screenshot_path}")
        
        print("Automation completed successfully!")
        
    except Exception as e:
        print(f"An error occurred: {str(e)}")
        # Take screenshot of error state
        driver.save_screenshot("/mnt/user-data/outputs/error_screenshot.png")
        
    finally:
        # Keep browser open for a few seconds before closing
        time.sleep(3)
        driver.quit()
        print("Browser closed.")

if __name__ == "__main__":
    main()
